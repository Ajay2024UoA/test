{{ config(materialized='table') }}

SELECT 
    CMS_CERTIFICATION_NUMBER_CCN,
    PROVIDER_NAME,
    PROVIDER_ADDRESS,
    CITY_TOWN,
    STATE,
    ZIP_CODE,
    REPORT_MONTH,
    REPORT_DATE,
    INSPECTION_CYCLE,
    -- Aggregated Deficiency Counts
    SUM(COUNT_OF_NUTRITION_AND_DIETARY_DEFICIENCIES) AS TOTAL_NUTRITION_DEFICIENCIES,
    SUM(COUNT_OF_EMERGENCY_PLANS_AND_FIRE_DRILLS_DEFICIENCIES) AS TOTAL_EMERGENCY_PLAN_DEFICIENCIES,
    SUM(COUNT_OF_ELECTRICAL_DEFICIENCIES) AS TOTAL_ELECTRICAL_DEFICIENCIES,
    SUM(COUNT_OF_EGRESS_DEFICIENCIES) AS TOTAL_EGRESS_DEFICIENCIES,
    SUM(COUNT_OF_LABORATORIES_DEFICIENCIES) AS TOTAL_LABORATORIES_DEFICIENCIES,
    SUM(COUNT_OF_ADMINISTRATION_DEFICIENCIES) AS TOTAL_ADMINISTRATION_DEFICIENCIES,
    SUM(COUNT_OF_RESIDENT_RIGHTS_DEFICIENCIES) AS TOTAL_RESIDENT_RIGHTS_DEFICIENCIES,
    SUM(COUNT_OF_INFECTION_CONTROL_DEFICIENCIES) AS TOTAL_INFECTION_CONTROL_DEFICIENCIES,
    SUM(COUNT_OF_SERVICES_DEFICIENCIES) AS TOTAL_SERVICES_DEFICIENCIES,
    SUM(COUNT_OF_RESIDENT_ASSESSMENT_AND_CARE_PLANNING_DEFICIENCIES) AS TOTAL_RESIDENT_ASSESSMENT_DEFICIENCIES,
    SUM(COUNT_OF_NURSING_AND_PHYSICIAN_SERVICES_DEFICIENCIES) AS TOTAL_NURSING_DEFICIENCIES,
    SUM(COUNT_OF_CORRIDOR_WALLS_AND_DOORS_DEFICIENCIES) AS TOTAL_CORRIDOR_DEFICIENCIES,
    SUM(COUNT_OF_PHARMACY_SERVICE_DEFICIENCIES) AS TOTAL_PHARMACY_DEFICIENCIES,
    SUM(COUNT_OF_GAS_AND_VACUUM_AND_ELECTRICAL_SYSTEMS_DEFICIENCIES) AS TOTAL_GAS_VACUUM_ELECTRICAL_DEFICIENCIES,
    SUM(COUNT_OF_FREEDOM_FROM_ABUSE_AND_NEGLECT_AND_EXPLOITATION_DEFICIENCIES) AS TOTAL_ABUSE_NEGLECT_DEFICIENCIES,
    SUM(COUNT_OF_MEDICAL_GASES_AND_ANAESTHETIZING_AREAS_DEFICIENCIES) AS TOTAL_MEDICAL_GASES_DEFICIENCIES,
    SUM(COUNT_OF_SMOKE_DEFICIENCIES) AS TOTAL_SMOKE_DEFICIENCIES,
    SUM(COUNT_OF_SMOKING_REGULATIONS_DEFICIENCIES) AS TOTAL_SMOKING_DEFICIENCIES,
    SUM(COUNT_OF_EMERGENCY_PREPAREDNESS_DEFICIENCIES) AS TOTAL_EMERGENCY_PREPAREDNESS_DEFICIENCIES,
    SUM(COUNT_OF_QUALITY_OF_LIFE_AND_CARE_DEFICIENCIES) AS TOTAL_QUALITY_OF_LIFE_DEFICIENCIES,
    SUM(COUNT_OF_ILLUMINATION_AND_EMERGENCY_POWER_DEFICIENCIES) AS TOTAL_ILLUMINATION_DEFICIENCIES,
    SUM(COUNT_OF_CONSTRUCTION_DEFICIENCIES) AS TOTAL_CONSTRUCTION_DEFICIENCIES,
    SUM(COUNT_OF_FIRE_ALARM_SYSTEMS_DEFICIENCIES) AS TOTAL_FIRE_ALARM_DEFICIENCIES,
    SUM(COUNT_OF_HAZARDOUS_AREA_DEFICIENCIES) AS TOTAL_HAZARDOUS_AREA_DEFICIENCIES,
    SUM(COUNT_OF_INTERIOR_DEFICIENCIES) AS TOTAL_INTERIOR_DEFICIENCIES,
    SUM(COUNT_OF_MISCELLANEOUS_DEFICIENCIES) AS TOTAL_MISCELLANEOUS_DEFICIENCIES,
    SUM(COUNT_OF_ENVIRONMENTAL_DEFICIENCIES) AS TOTAL_ENVIRONMENTAL_DEFICIENCIES,
    SUM(COUNT_OF_AUTOMATIC_SPRINKLER_SYSTEMS_DEFICIENCIES) AS TOTAL_SPRINKLER_DEFICIENCIES,
    -- Sum of Total Deficiencies
    SUM(TOTAL_NUMBER_OF_HEALTH_DEFICIENCIES) AS TOTAL_HEALTH_DEFICIENCIES,
    SUM(TOTAL_NUMBER_OF_FIRE_SAFETY_DEFICIENCIES) AS TOTAL_FIRE_SAFETY_DEFICIENCIES,
    -- Most Recent Dates (using FIRST_VALUE to get the most recent)
    FIRST_VALUE(HEALTH_SURVEY_DATE IGNORE NULLS) OVER (PARTITION BY CMS_CERTIFICATION_NUMBER_CCN ORDER BY HEALTH_SURVEY_DATE DESC) AS MOST_RECENT_HEALTH_SURVEY_DATE,
    FIRST_VALUE(FIRE_SAFETY_SURVEY_DATE IGNORE NULLS) OVER (PARTITION BY CMS_CERTIFICATION_NUMBER_CCN ORDER BY FIRE_SAFETY_SURVEY_DATE DESC) AS MOST_RECENT_FIRE_SAFETY_SURVEY_DATE
FROM {{ source('BRONZE', 'NH_SURVEY_SUMMARY') }}
GROUP BY 
    CMS_CERTIFICATION_NUMBER_CCN,
    PROVIDER_NAME,
    PROVIDER_ADDRESS,
    CITY_TOWN,
    STATE,
    ZIP_CODE,
    REPORT_MONTH,
    REPORT_DATE,
    INSPECTION_CYCLE
